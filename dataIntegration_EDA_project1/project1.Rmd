---
title: "Data Integration and EDA"
author: "Hanan Salim"
output: html_notebook
---


```{r setup, include=FALSE, warning=FALSE}
#Detect, install and load packages if needed.
if (!require("knitr")) {
   install.packages("knitr")
   library(knitr)
}

if (!require("odbc")) {
   install.packages("odbc")
   library(odbc)
}

if (!require("DBI")) {
   install.packages("DBI")
   library(DBI)
}

if (!require("RSQLite")) {
   install.packages("RSQLite")
   library(RSQLite)
}

if (!require("tidyverse")) {
   install.packages("tidyverse")
   library(tidyverse)
}

if (!require("patchwork")) {
   install.packages("patchwork")
   library(patchwork)
}

if (!require("reshape2")) {
   install.packages("reshape2")
   library(reshape2)
}

if (!require("GGally")) {
   install.packages("GGally")
   library(GGally)
}

# specifications of outputs of code in code chunks
knitr::opts_chunk$set(echo = TRUE,       #include code chunk in the output file
                      warnings = FALSE,  #suppress warnings in outputs,
                      messages = FALSE,  #prevents messages generated by code in output
                      results = TRUE,    #include output in file.
                      comment = NA
                      )   
```

```{r, include=FALSE}
#read in data
countyElection <- read.csv("/Users/hsalim/sta551/project1/countypresidential_election_2000-2020.csv")
education <- read.csv("/Users/hsalim/sta551/project1/Education.csv")
povertyEstimates <- read.csv("/Users/hsalim/sta551/project1/PovertyEstimates.csv")
unemployment <- read.csv("/Users/hsalim/sta551/project1/Unemployment.csv")
```

```{r, include=FALSE}
#Create database
con <- dbConnect(drv = SQLite(),
                 dbname = "oneSQL")

#store sample data in the database
dbWriteTable(conn = con, 
             name = "countyElection",
             value = countyElection)

dbWriteTable(conn = con, 
             name = "education",
             value = education)

dbWriteTable(conn = con, 
             name = "povertyEstimates",
             value = povertyEstimates)

dbWriteTable(conn = con, 
             name = "unemployment",
             value = unemployment)
 
#remove the local data from the environment
rm(countyElection, education, povertyEstimates, unemployment)
```


# Introduction
We are presented with four data sets: Presidential Election Data, Unemployment Data, Poverty Data, and Education Data. We begin by inspecting the data and extracting relevant columns.

```{r}
tbl(src = con, c("countyElection"))
```

```{sql, connection = "con", output.var = "ConditionalQuery"} 
SELECT * 
FROM ( 
      SELECT state, 
            county_name, 
            county_fips, 
            party, 
            candidatevotes
      FROM countyElection 
      WHERE (party = "REPUBLICAN" OR 
            party = "DEMOCRAT") AND 
            year = 2020
      GROUP BY party,
            county_name
      ORDER BY SUM(candidatevotes) DESC)
GROUP BY county_name
ORDER BY MAX(candidatevotes) DESC;
```

```{r}
tbl(src = con, c("unemployment"))
```

```{sql, connection = "con", output.var = "unemploymentConditional"}
SELECT FIPS_Code, Value
FROM unemployment 
WHERE Attribute LIKE "Unemployment_rate_2000"
```


```{r}
tbl(src = con, c("povertyEstimates"))
```

```{sql, connection = "con", output.var = "povertyConditional"}
SELECT FIPStxt,Value 
FROM povertyEstimates 
WHERE Attribute LIKE "PCTPOVALL_2019"
```


```{r}
tbl(src = con, c("education"))
```

```{sql, connection = "con", output.var = "educationConditional"}

SELECT "FIPS.Code",
       "Percent.of.adults.with.less.than.a.high.school.diploma..2015.19",
       "Percent.of.adults.with.a.high.school.diploma.only..2015.19",
       "Percent.of.adults.completing.some.college.or.associate.s.degree..2015.19",
       "Percent.of.adults.with.a.bachelor.s.degree.or.higher..2015.19"
from education
```

```{r}
dbWriteTable(conn = con, 
             name = "ConditionalQuery",
             value = ConditionalQuery)

dbWriteTable(conn = con, 
             name = "educationConditional",
             value = educationConditional)

dbWriteTable(conn = con, 
             name = "povertyConditional",
             value = povertyConditional)

dbWriteTable(conn = con, 
             name = "unemploymentConditional",
             value = unemploymentConditional)

rm(ConditionalQuery, educationConditional, povertyConditional, unemploymentConditional)

```


## Data Cleaning

Our data has long column names and duplicate column which we rename. We also notice that there are several missing values across our data. We choose to omit them when necessary for this EDA but for numeric data, we could impute for further analysis. For missing party, county, FIPS code information, we will always drop the given data point.

```{sql, connection = "con", include=FALSE}
ALTER TABLE unemploymentConditional RENAME COLUMN Value TO unemployment_rate 
```

```{sql, connection = "con", include=FALSE}
ALTER TABLE povertyConditional RENAME COLUMN Value TO poverty_rate 
```

```{sql, connection = "con", include=FALSE}
ALTER TABLE educationConditional RENAME COLUMN "Percent.of.adults.with.less.than.a.high.school.diploma..2015.19"
      TO percent_less_than_HS_edu
```
```{sql, connection = "con", include=FALSE}
ALTER TABLE educationConditional RENAME COLUMN "Percent.of.adults.with.a.high.school.diploma.only..2015.19"  
      TO percent_HS_edu
```

```{sql, connection = "con", include=FALSE}
ALTER TABLE educationConditional RENAME COLUMN "Percent.of.adults.completing.some.college.or.associate.s.degree..2015.19"
      TO percent_some_college_edu
```

```{sql, connection = "con", include=FALSE}
ALTER TABLE educationConditional RENAME COLUMN "Percent.of.adults.with.a.bachelor.s.degree.or.higher..2015.19"  
      TO percent_bachelors_or_more_edu
```

```{sql, connection = "con", output.var = "fullData"} 
SELECT *
FROM povertyConditional
  FULL JOIN educationConditional 
    ON povertyConditional.FIPStxt = educationConditional."FIPS.Code"
  FULL JOIN unemploymentConditional 
    ON educationConditional."FIPS.Code" = unemploymentConditional.FIPS_code
  FULL JOIN ConditionalQuery
    ON unemploymentConditional.FIPS_code = ConditionalQuery.county_fips
```

# Data Visualization

## Distribution of Numeric Data

To understand the distribution for our 7 numeric columns, we chose to produce density plots to visualize the distribution. From this we notice that:

1. Both poverty rate and unemployment rates are right skewed. 
2. A few large counties dominate the voting counts thus skewing our data.
3. The education rate differ quite a bit.

```{r, warning=FALSE}
unemploymentRateDistPlot <- ggplot(fullData, aes(x=unemployment_rate)) + 
                              geom_density() + 
                              geom_vline(aes(xintercept=mean(unemployment_rate, na.rm=TRUE)),
                                color="red", size=.5, linetype="dashed") +
                              theme_classic() +
                              theme(plot.title = element_text(size=10)) + 
                              xlab("Unemployment Rate") +
                              labs(title = "Unemployment Rate Distribution")

povertyRateDistPlot <- ggplot(fullData, aes(x=poverty_rate)) + 
                              geom_density() + 
                              geom_vline(aes(xintercept=mean(poverty_rate, na.rm=TRUE)),
                                color="red", size=.5, linetype="dashed") +
                              theme_classic() +
                              theme(plot.title = element_text(size=10)) + 
                              xlab("Poverty Rate") +
                              labs(title = "Poverty Rate Distribution")

candidateVotesDistPlot <- ggplot(fullData, aes(x=candidatevotes)) + 
                              geom_density() + 
                              theme_classic() +
                              theme(plot.title = element_text(size=10)) + 
                              geom_vline(aes(xintercept=mean(candidatevotes, na.rm=TRUE)),
                                color="red", size=.5, linetype="dashed") +
                              xlab("Canidates Votes") +
                              labs(title = "Winning Canidate Vote Distribution")

educationMelt <- melt(fullData[4:7])
educationDistPlot <- ggplot(educationMelt, aes(x=value, colour=variable)) + 
                              geom_density() +
                              theme_classic() +
                              theme(plot.title = element_text(size=10)) + 
                              xlab("Percent of Adults") +
                              labs(title = "Education Levels of Adults Distribution", size=10) + 
                              scale_color_discrete(name="Education Levels",
                                breaks=c(
                                  "percent_less_than_HS_edu",
                                  "percent_HS_edu",
                                  "percent_some_college_edu",
                                  "percent_bachelors_or_more_edu"),
                                labels=c("Less than high school", 
                                         "High school", 
                                         "Some college",
                                         "Bachelor's or higher"))


(unemploymentRateDistPlot + povertyRateDistPlot) / (candidateVotesDistPlot + educationDistPlot)
```

## Categorical distributions

We would like to now take a look at the categorical variables, starting with the party column. First we tabulate the number of counties each party one. There is a 2:1 ratio in favor of republicans for the 2020 election cycle. If we look at the median votes caste for each party across all counties, democrats win more populated counties which makes the skew in our first table not too surprising.

```{r}
table(fullData$party)
```

```{r}
fullData %>% na.omit() %>% group_by(party) %>%  summarise(median = median(candidatevotes)) 
```

## Education Level Differences by Party

Is there any difference between the two main parties when it comes to education levels? To check, we created density plots comparing Republicans vs Democrats for each education level in our data. From this, we can see that those with less than a high school education have a similar distribution for both parties. This is also the case for the distribution of adults with some college. But, there is a large difference in the other two categories. Republican parties tend to have a much larger percentage of adults with a high school diploma, where as counties that voted Democrats tend to be college educated. From this we can that there is some relationship between voting patterns and education levels.

```{r}
fullDataNARM <- fullData %>% na.omit 
lessThanHS <- ggplot(data=fullDataNARM, aes(x=percent_less_than_HS_edu, color=party)) + 
                    geom_density() + 
                    theme_classic() +
                    theme(plot.title = element_text(size=10)) +
                    xlab("Percentage") + 
                    labs(title = "Adults with < High School Education")

HSdiploma <- ggplot(data=fullDataNARM, aes(x=percent_HS_edu, color=party)) +
                    geom_density() + 
                    theme_classic() +
                    theme(plot.title = element_text(size=10)) +
                    xlab("Percentage") + 
                    labs(title = "Adults with High School Diploma")

someCollege <- ggplot(data=fullDataNARM, aes(x=percent_some_college_edu, color=party)) + 
                    geom_density() + 
                    theme_classic() +
                    theme(plot.title = element_text(size=10)) +
                    xlab("Percentage") + 
                    labs(title = "Adults with some college Education")

collegeOrMore <- ggplot(data=fullDataNARM, aes(x=percent_bachelors_or_more_edu, color=party)) + 
                    geom_density() + 
                    theme_classic() +
                    theme(plot.title = element_text(size=10)) +
                    xlab("Percentage") + 
                    labs(title = "Adults with Bachelor's or Higher")


(lessThanHS + HSdiploma) / (someCollege + collegeOrMore)
```

# Corelation Analysis

We would like to know do a pairwise comparison. For this we would like to see if any of our continuous variables are correlated with each other by calculating the pearson coefficient $$r = \frac{\sum(x_i - \bar x)(y_i - \bar y)}{\sqrt{\sum(x_i - \bar x)^2 \sum(y_i - \bar y)^2}}$$. From the plot we can see that a college education is inversely correlated with poverty and unemployment rates. On the other hand, having a high school education or less is positively correlated with poverty and unemployment rates. Furthermore, the poverty rate and unemployment rate for counties are correlated.



```{r}
numericData <- fullDataNARM[, c(2,4,5,6,7,9,14)]

correlationMatrix <- round(cor(numericData, method = "pearson"),2)  

dist <- as.dist((1-correlationMatrix)/2)
hc <- hclust(dist)
correlationMatrix <-correlationMatrix[hc$order, hc$order]

correlationMatrixMelt <- melt(correlationMatrix)

ggplot(data = correlationMatrixMelt, aes(x=Var1, y=Var2, fill=value)) + 
        geom_tile() + 
        theme_classic() +
        theme(axis.text.x = element_text(angle = 30, hjust=1),
              axis.title.x = element_blank(),
              axis.title.y = element_blank()) +
        geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) + 
        labs(title ="Pearson Correlation Heatmap") +
        scale_fill_gradient2()
```
# Regional Differences

Are there any regional differences in our variables? To check, we want to group our data by state and then plot averages for our continuous variables to check to spot any correlations between states and education, poverty, and unemployment rates.

```{r}
dataMeans <- fullData %>% na.omit() %>% 
             group_by(state) %>%  
             summarise(across(c(unemployment_rate, poverty_rate,percent_bachelors_or_more_edu), mean)) 

unemploymentMeanPlot <- ggplot(data=dataMeans, aes(x=reorder(state,-unemployment_rate), y=unemployment_rate)) + 
                            theme_classic() +
                            theme(axis.text.x = element_text(angle = 90, hjust=1)) +
                            geom_bar(stat = "identity") + 
                            xlab("States") + 
                            ylab("Unemployment Average") + 
                            labs(title ="Unemployment Rate Averages Across States")

povertyMeanPlot <- ggplot(data=dataMeans, aes(x=reorder(state,-poverty_rate), y=poverty_rate)) + 
                            theme_classic() +
                            theme(axis.text.x = element_text(angle = 90, hjust=1)) +
                            geom_bar(stat = "identity") + 
                            xlab("States") + 
                            ylab("Poverty Average") + 
                            labs(title ="Poverty Rate Averages Across States")

BSMeanPlot <- ggplot(data=dataMeans, aes(x=reorder(state,-percent_bachelors_or_more_edu), y=percent_bachelors_or_more_edu)) + 
                            theme_classic() +
                            theme(axis.text.x = element_text(angle = 90, hjust=1)) +
                            geom_bar(stat = "identity") + 
                            xlab("States") + 
                            ylab("Bachelor's Degree Percent Average") + 
                            labs(title ="Percent of Adult with Bachelor's or more Across States")
```


Looking carefully at the three plots below, we notice that:

1. The average percentage of Bachelor's Degree holders in state is inversely correlated with its poverty rate.
2. Unemployment is a mixed bag. Washington stands as an outlier, having high levels of education and medium poverty rates but high unemployment.
3. Coastal states are more educated and have lower poverty rates than interior states. There is a regional bias to our data.

```{r}
unemploymentMeanPlot
```
```{r}
povertyMeanPlot
```

```{r}
BSMeanPlot
```
